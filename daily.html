<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>MentalMatters</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="css/styles.css" rel="stylesheet" />
</head>

<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav" style="background-color: #68a49c;">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="#page-top">MentalMatters</a>
            <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
                aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="daily.html">Daily</a></li>
                    <li class="nav-item"><a class="nav-link" href="help.html">Help</a></li>
                    <li class="nav-item"><a class="nav-link" href="progress.html">Progress</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Masthead-->
    <!-- <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-uppercase">Grayscale</h1>
                        <h2 class="text-white-50 mx-auto mt-2 mb-5">A free, responsive, one page Bootstrap theme created by Start Bootstrap.</h2>
                        <a class="btn btn-primary" href="#about">Get Started</a>
                    </div>
                </div>
            </div>
        </header> -->
    <!-- About-->
    <!-- <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">Built with Bootstrap 5</h2>
                        <p class="text-white-50">
                            Grayscale is a free Bootstrap theme created by Start Bootstrap. It can be yours right now, simply download the template on
                            <a href="https://startbootstrap.com/theme/grayscale/">the preview page.</a>
                            The theme is open source, and you can use it for any purpose, personal or commercial.
                        </p>
                    </div>
                </div>
                <img class="img-fluid" src="assets/img/ipad.png" alt="..." />
            </div>
        </section> -->
    <!-- Projects-->
    <section class="signup-section bg-light" style="padding-bottom: 20rem;padding-top: 15rem;" id="quiz">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5">
                <div class="col-md-10 col-lg-8 mx-auto text-center">
                    <i class="far fa-paper-plane fa-2x mb-2 text-white"></i>
                    <h2 class="text-white mb-5">Daily Reflection</h2>
                </div>
                <div class="col-md-10 col-lg-8 mx-auto">
                    <ol id="input_list" class="text-white">
                        <form class="form-signup">

                            <style>
                                .question-item {
                                    /*  spacing for questions */
                                    margin-bottom: 2rem;
                                }

                                .form-control::placeholder {
                                    /* color for placeholder text */
                                    color: #bebebe;
                                }
                            </style>

                            <li>Describe your day, how did it make you feel?</li>
                            <div class="row input-group-newsletter">
                                <div class="col">

                                    <textarea class="form-control" placeholder="Write about your mood..."
                                        rows="3"></textarea>
                                </div>
                                <div class="col-auto"> </div>
                            </div>

                            <li class="mt-3">How stressed were you and why?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your stress..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">When did you feel energized throughout the day? Why or why not?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your energy level..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">How much sleep did you get last night? Did you feel well rested? </li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your sleep..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">Describe your exercise today. Do you usually exercise this much? </li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your exercise..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">What did you have to eat? How full did you feel, and how healthy was each
                                meal?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your diet..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">Did you have enough social interaction? Who did you talk to today?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your social interaction..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">What did you do today for fun?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your recreation..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">How productive were you today? Are there any achievements you’re proud of?
                            </li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your productivity..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">What are you looking forward to? What are you not looking forward to?</li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write about your optimism..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">Journal Entry: </li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write today's journal entry..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>


                            <li class="mt-3">Words of Wisdom (for your future self): </li>
                            <div class="row input-group-newsletter">
                                <div class="col"><textarea class="form-control" rows="3"
                                        placeholder="Write what you learned today..."></textarea></div>
                                <div class="col-auto"> </div>
                            </div>




                        </form>
                        <div class="mt-4">
                            <button id="saveButton" class="btn btn-primary" onclick="sendMessage();">Submit</button>

                        </div>
                    </ol>
                </div>
            </div>
        </div>
    </section>
    <!-- Footer-->
    <footer class="footer bg-black small text-center text-white-50">
        <div class="container px-4 px-lg-5">MentalMatters 2024</div>
        <div class="social d-flex justify-content-center">
            <a class="mx-2" href="https://github.com/chrisl779/mental" target="_blank"><i class="fab fa-github"></i>
                Github </a>
        </div>
    </footer>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>

    <script>
        let journal_entry = '';
        let words_of_wisdom = '';


        function parseResult(results, summary) {

            console.log('=======parseResult()====================')
            console.log(results);
            console.log('===========================')


            var resultObj = {};
            if (results.length > 0) {
                resultObj['response1'] = {
                    'Happiness': {
                        'score': '',
                        'text': ''
                    },
                    'Best Area': {
                        'score': '',
                        'text': ''
                    },
                    'Worst Area': {
                        'score': '',
                        'text': ''
                    },
                    'Summary': summary
                };
                resultObj['journal'] = journal_entry;
                resultObj['wisdom'] = words_of_wisdom;

                var lines = results[0].split("\n");
                const regex = /\d+\/\d+/gm;
                for (var line of lines) {
                    console.log("  >>> " + line);
                    var b = false;
                    var item = null;
                    if (line.toLowerCase().indexOf('happiness') != -1) {
                        console.log("happy ==>");
                        item = resultObj.response1.Happiness;
                    }
                    if (line.toLowerCase().indexOf('best area') != -1) {
                        console.log("best ==>");
                        item = resultObj.response1['Best Area'];
                    }
                    if (line.toLowerCase().indexOf('worst area') != -1) {
                        console.log("worst ==>");
                        item = resultObj.response1['Worst Area'];
                        b = true;
                    }
                    if (item != null) {
                        const match = line.match(regex);
                        item['score'] = match[0];
                        item['text'] = line.substr(line.indexOf('_') + 1).trim();
                    }
                    if (b) break;
                }
            }
            if (results.length > 1) {
                resultObj['response2'] = results[1].trim();
            }

            // "You've co"
            // save to localstorage            
            // format : yyyy-mm-dd  2024-09-24
            var today = getTodayString();
            localStorage.setItem(today, JSON.stringify(resultObj));
            // set today as the reference date of the progress page
            localStorage.setItem('target_date', today);

        }

        async function sendMessage() {

            var results = [];

            let user_response = 'This is for a website regarding mental health.'
                + 'Every day, we give our users a test about their general health'
                + '“areas” including mood, stress, energy, rest, exercise, diet, social life,'
                + 'recreation, productivity, optimism. See the responses below, separated by a newline.\n'
                + 'the questions the user is answer include: 1.Describe your day, how did it make you feel?'
                + '2.How stressed were you and why? 3.When did you feel energized throughout the day? Why or why not?'
                + '4. How much sleep did you get last night? Did you feel well rested?'
                + '5. Describe your exercise today. Do you usually exercise this much?'
                + '6. What did you have to eat? How full did you feel, and how healthy was each meal?'
                + '7. Did you have enough social interaction? Who did you talk to today?'
                + '8. What did you do today for fun?'
                + '9. How productive were you today? Are there any achievements you’re proud of?'
                + '10. What are you looking forward to? What are you not looking forward to?'
                + 'The answers the user provided are: \n';
            var items = document.getElementsByTagName('textarea');
            for (let i = 0; i < items.length; i++) {
                if (i == items.length - 2) {
                    journal_entry += items[i].value.trim();
                }
                if (i == items.length - 1) {
                    words_of_wisdom += items[i].value.trim();
                }
                user_response += '\n' + items[i].value.trim();
            }

            ////////////// TEST QUERY /////////////////////
            /*
            let test_query = 'This is for a website regarding mental health.'
                 + 'Every day, we give our users a test about their general health'
                 + ' “areas” including mood, stress, energy, rest, exercise, diet, social life,'
                 + ' recreation, productivity, optimism. See the responses below, separated by a newline.\n';

             var tq=["Today was a good day, it felt good to see my friends",//1
                 "I wasn't very stressed out today",
                 "I felt very energized throughout the entirety of the day",
                 "I did not get enough sleep, only 6 hours because I was cramming for a test.",
                 "I had gym class today, but nothing much besides that. ",
                 "I had 3 very nice well rounded meals, and didn't have any issues with that",//6
                 "I talked to my friends at school today!",
                 "I played video games today for fun!",
                 "I didn't get enough homework done because I was playing video games",
                 "I am looking forward to the weekend so there will be no school! I am not looking forward to monday because I have 3 tests.",
                 "Today went pretty well. I had school and no tests",//11
                 "Always keep pushing!"
             ];
            
             for (let i = 0; i < tq.length; i++) {
                 if (i == tq.length - 2) {
                     journal_entry += tq[i];
                 }
                 if (i == items.length - 1) {
                     words_of_wisdom += tq[i];
                 }
                 user_response += '\n' + tq[i];
             }
            user_response = test_query;
            */
            ////////////// TEST QUERY /////////////////////




            user_response += 
                `\n Please declare a "happiness" rating out of 10 for the user. Consider the trajectory of their week, month, and year
            Then put an underline, and a ~500 character explanation citing actual events they mentioned or previously mentioned.
            Example: “Happiness: 6/10_Today was fine because… *insert explanation here* ”
            
            Using this response and other responses from this week (or further back), please find the best ”area” first (Best Area:) 
            and worst “area” (Worst Area:) giving rating out of 10 and few sentences (~500 char) for both. Cite potential causes, and suggest what could
            happen if the user worked their worst area more. 
            Example: “Stress: 10/10_Stress management is a strong….” newline 
            “Sleep: 2/10_Struggles with sleep because…”.
            
            Then, please briefly write a summary (in bullet points) for yourself to remember. Anwhere between 5 and 10 bullets is fine.
            The summary shall include things like actions, people, places, activities, thoughts, possible feelings, possible emotions. en. 
            Please be on the lookout for possible mental disorder symptoms.This means, if you notice patterns of anxiety, depression, or other mental health
            illnesses/disorders, please respectfully and with care suggest that their symptoms may point to a mental health disorder. If this happens, 
            immediately suggest to contact a professional as soon as possible.
            Otherwise, write about the crucial ideas, people, emotions, places, activities, etc. Try to be specific `

            console.log(user_response);


            const response = await fetch('https://us-central1-mentalhealthapp-8c73b.cloudfunctions.net/getOpenAIResponse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [{ role: 'user', content: user_response }]
                })
            });

            const data = await response.json();
            const botMessage = data.result.response;
            //downloadFile(botMessage);
            var si = botMessage.indexOf('Summary');
            var si2 = botMessage.indexOf('\n-');
            var summary = '';
            if (si != -1) {
                summary = botMessage.substr(si);
            } else if (si2 != -1) {
                summary = botMessage.substr(si2 + 1);
            }

            console.log('------------------------------');
            console.log(botMessage);
            console.log('------------------------------');


            let query2 =
                'Read the data below. there are various scores and areas, as well as a summary for yourself.'
                + botMessage +
                `Consider the happiness, explanations, best and worst areas. Then, out of these categories: 

            [-> Exercise
                Cardiovascular (Walking, jogging, running, cycling) 
                Strength (Weight training, calisthenics)
            -> Sleep
                Tips on how to get better sleep, fall asleep quicker
            -> Diet
                Tips on how to get balanced meals
            -> Mindfulness 
                Tips on how to do breathing
                Words of gratitude practicing
            -> Goals
                Set short term, mid term, long term goals - cross them off once accomplished
            -> Stress
                Identify, confront, and eliminate things/situations that cause stress]

            List the top 3 categories (from above, with "->" before them) the user would see benefit from, and a short blurb about why (2-3 sentences). 
            Lead with the category, then a colon:
            Example: “Exercise: The user should be more active because… Diet: A healthy diet can provide benefits… 
            Goals: Motivation can help accomplish more…” seperate the 3 with newlines`

            const response2 = await fetch('https://us-central1-mentalhealthapp-8c73b.cloudfunctions.net/getOpenAIResponse', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: [{ role: 'user', content: query2 }]
                })
            });

            const data2 = await response2.json();
            const botMessage2 = data2.result.response;
            results.push(botMessage2);
            // console.log('-------------------------');
            // console.log(results);
            // console.log('-------------------------');

            parseResult(results, summary);

            // redirect to progress page
            // window.location = 'progress.html';

        }

        document.addEventListener("DOMContentLoaded",
            function () {
                sign_in_checker();
                const saveButton = document.getElementById("saveButton");
                const inputItem = document.getElementById("input_list");
                const today = getTodayString();

                // Check if today's quote is already saved

                if (localStorage.getItem(today)) { // removes questions and input boxes if already submitted today
                    saveButton.disabled = true;
                    inputItem.innerHTML = '<h4>You\'ve already completed your reflection today :) </h4> <h4>Please come back tomorrow</h4>';
                    inputItem.style = 'text-align:center !important';
                    //
                }
            }
        );


    </script>
</body>

</html>